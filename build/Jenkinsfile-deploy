#!/usr/bin/env groovy

pipeline {
  agent {
    label 'jenkins-slave'
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }

  environment {
    PROFILE = 'dev'
    BRANCH_NAME = "${GIT_BRANCH}"
    GIT_COMMIT = sh(returnStdout: true, script: 'make git-commit-get-hash')
    GIT_TAG = "${GIT_BRANCH}"
  }

  stages {
    stage('Set up Variables') {
      steps {
        script {
          sh 'make devops-print-variables'
          this.BRANCH_NAME = env.BRANCH_NAME
          sh "echo BRANCH_NAME=${BRANCH_NAME}"
          sh "echo GIT_COMMIT=${GIT_COMMIT}"
          sh "echo GIT_TAG=${GIT_TAG}"
        }
      }
    }
    stage('Check Deployment') {
      steps {
        script {
          IS_MASTER_BRANCH = sh(returnStdout: true, script: "make git-tag-is-present-on-branch TAG=${GIT_TAG} BRANCH=master").trim()
          if (IS_MASTER_BRANCH == 'false') {
            sh "echo Git Tag is not present on specified branch"
            error('Failing build because tag is not on the correct branch...')
          }
          if (this.GIT_TAG.split('-')[-1] == 'prod') {
            this.PROFILE = 'prod'
          } else if (this.GIT_TAG.split('-')[-1] == 'demo') {
            this.PROFILE = 'demo'
          } else {
            this.PROFILE = 'dev'
          }
          IS_RC = sh(returnStdout: true, script: "make git-tag-is-release-candidate COMMIT=${GIT_COMMIT}").trim()
          if ((this.PROFILE == 'prod' || this.PROFILE == 'demo') && IS_RC == 'false') {
            // Evaluate tags to check for Release Candidate, if no RC tag, don't deploy
            sh "echo Not a release candidate"
            error('Failing build because commit is not marked as a release candidate...')
          }
        }
      }
    }
    stage('Provision Infrastructure') {
      steps {
        script {
            sh "echo Checking to see if RDS Snapshot is needed"
            if (this.PROFILE != 'dev') {
              sh "echo Creating RDS Snapshot"
              sh "make backup-data"
            }
        }
        script {
          sh "echo Provisioning infrastructure for ${PROFILE} environment"
          sh 'make docker-config'
          sh "make terraform-apply-auto-approve STACKS=service PROFILE=${PROFILE} OPTS='--var-file=../tfvars/${PROFILE}.tfvars' | tee /tmp/terraform_changes.txt"
        }
        script {
          sh "make secret-update-db-password"
        }
      }
    }
    stage('Deploy Application') {
      steps {
        script {
          sh "make deploy PROFILE=${PROFILE} API_IMAGE_TAG=${GIT_TAG} PROXY_IMAGE_TAG=${GIT_TAG} | tee /tmp/deployment_stats.txt"
        }
      }
    }
    stage('Load Test Data') {
      when { expression { this.PROFILE == 'dev' } }
      steps {
        script {
          sh "make deploy-job PROFILE=${PROFILE} STACK=data || :"
        }
      }
    }
    // stage("Run Tests") {
    //     steps {
    //         script {
    //             sh 'make test'
    //         }
    //     }
    // }
    stage('Deployment Summary') {
      steps {
        script {
          sh 'echo Terraform Changes'
          sh "cat /tmp/terraform_changes.txt | grep -E 'Apply...'"
          sh 'echo Is deployment running?'
          sh "cat /tmp/deployment_stats.txt | grep -E 'Display namespaces' --after-context=100"
          sh 'echo URL'
          sh 'make url'
        }
      }
    }
  }
  post {
    success {
      script {
        if (this.PROFILE != 'dev') {
          sh """
            export BUILD_STATUS=${currentBuild.currentResult}
            export PIPELINE_NAME='Deploy Pipeline'
            make slack-it
          """
        }
      }
    }
    failure {
      script {
        sh """
          export BUILD_STATUS=${currentBuild.currentResult}
          export PIPELINE_NAME='Deploy Pipeline'
          make slack-it
        """
        sh 'make jenkins-upload-workspace'
      }
    }
    cleanup {
      script {
        script {
          sh 'make clean'
        }
      }
    }
  }
}
